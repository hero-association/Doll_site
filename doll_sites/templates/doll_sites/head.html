<head>

    <meta name="renderer" content="webkit">
    <meta name="referrer" content="never">
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="applicable-device" content="pc,mobile">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta name="description" content="{{ description }}" />
    <meta name="keywords" content="{{ keywords }}" />
    <title>{{ title }}</title>

<!-- 引入 Bootstrap -->
  <link rel='stylesheet' href='/static/css/bootstrap.css'>
  <link rel='stylesheet' href='/static/css/style.css'>
  <link rel='stylesheet' href='/static/css/video-js.css'>
  <link rel='stylesheet' href='/static/css/zoom.css'>

<!-- fontawsome -->
  <link href="/static/css/all.css" rel="stylesheet">
<!--load all styles -->

<!-- Baidu ZhanZhang Verify -->
  <meta name="baidu-site-verification" content="jiNtuP7fb1" />
<!-- Sogou Verify -->
  <meta name="sogou_site_verification" content="NSpQ4kboB4"/>

<!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-127776067-1"></script>
  
  <script>

    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());



    window.onload = function () {

      var getUserInfo = function () {
        const xhr = new XMLHttpRequest();

        xhr.open('GET', '/get_user_info', true);

        xhr.onload = function () {
          if (this.status === 200) {
            var userInfo = JSON.parse(this.responseText);
            setUserId(userInfo.user_id, userInfo.user_status);
            // console.log(userInfo.user_id);
            // console.log(userInfo.user_status);
          }
        }
        xhr.send();

      }

      getUserInfo();

      //构造带参数的请求地址，用于获取订单详情
      var order_item = getUrlParam('item');
      var photo_id = {{ photo_detail.id }}
      var get_url = '/get_order_info?item='
      get_url = get_url + order_item + '&photo_id=' + photo_id
      //当检查到paid信号时，获取订单详情
      var getPaidInfo = function () {
        if ( getUrlParam('paid') === 'true' ) {
          const osign = new XMLHttpRequest();
          osign.open('GET', get_url, true)
          //上报订单各参数，完成统计
          osign.onload = function () {
            if (this.status === 200) {
              var paidInfo = JSON.parse(this.responseText);
              gtag('event', 'order', {'send_to': 'UA-127776067-1','event_category': 'order_item','event_label': osign.order_item});
              gtag('event', 'order', {'send_to': 'UA-127776067-1','event_category': 'order_detail','event_label': osign.order_detail});
              gtag('event', 'order', {'send_to': 'UA-127776067-1','event_category': 'origin_page','event_label': osign.origin_page});
              gtag('event', 'order', {'send_to': 'UA-127776067-1','event_category': 'origin_actress','event_label': osign.origin_actress});
              gtag('event', 'order', {'send_to': 'UA-127776067-1','event_category': 'origin_series','event_label': osign.origin_series});
              gtag('event', 'order', {'send_to': 'UA-127776067-1','event_category': 'origin_race','event_label': osign.origin_race});
            }
          }
          osign.send();
        }
      }

      getPaidInfo();

    }



    function setUserId(userId, userStatus) {
      gtag('config', 'UA-127776067-1', {

        'user_id': userId,
        'custom_map': {'dimension2': 'user_status'}
      });

      // var user_status = userStatus ;

      gtag('set', { 'user_id': userId}); // 使用已登录的 user_id 来设置用户 ID。

      gtag('event', 'userStatus_dimension', {'user_status': userStatus});
     

      gtag('send', 'pageview');


    }


    //paraName 获取URL中的参数
　　function getUrlParam(paraName) {
　　　　var url = document.location.toString();
　　　　var arrObj = url.split("?");

　　　　if (arrObj.length > 1) {
　　　　　　var arrPara = arrObj[1].split("&");
　　　　　　var arr;

　　　　　　for (var i = 0; i < arrPara.length; i++) {
　　　　　　　　arr = arrPara[i].split("=");

　　　　　　　　if (arr != null && arr[0] == paraName) {
　　　　　　　　　　return arr[1];
　　　　　　　　}
　　　　　　}
　　　　　　return "";
　　　　}
　　　　else {
　　　　　　return "";
　　　　}
　　}
    



  </script>



</head>